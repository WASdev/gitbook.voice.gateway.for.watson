# Securing the voice gateway

By securing the voice gateway, you can reduce your exposure to vulnerabilities such as denial-of-service attacks. Configuring security is _especially_ important if you deploy the voice gateway to a public cloud because it can be accessed by anyone with a SIP phone.

* [Connect through a proxy server](#connecting-through-a-proxy-server)
* [Configure SSL/TLS encryption](#configuring-ssltls-encryption)
* [Whitelist callers and callees](#whitelisting-callers-and-callees)

## Connecting through a proxy server

For additional security, your organization might deploy the voice gateway in a environment that requires HTTP requests to pass through a proxy server. In this environment, you must configure the voice gateway to connect through the proxy server to the Watson services.

**Beta limitations:** Currently, you can connect to proxy servers only over HTTP, and HTTPS is not supported. Additionally, proxy authentication is supported only by the Media Relay (`voice-gateway-mr`) container. For the SIP Orchestrator (`voice-gateway-so`) container, you can specify only proxy servers that do not require proxy authentication.

In the SIP Orchestrator and Media Relay [configuration files](config.md), specify your proxy server details in the following environment variables:

| Environment variable | Default value | Description |
| --------- | --------- | ----------|
| PROXY_HOST | none | Host of the proxy server. |
| PROXY_PORT | none | Port of the proxy server. |
| PROXY_USERNAME | none | User name for proxy authentication. Supported only by the Media Relay. |
| PROXY_PASSWORD | none | Password for proxy authorization. Supported only by the Media Relay. |   
<!--| PROXY_TYPE | http | Defines the protocol to use for the proxy connection. | -->

## Configuring SSL/TLS encryption

Configuring SSL and TLS encryption for the voice gateway requires PEM and PKCS #12 files that are mounted on a Docker data volume and then referenced in the configuration for each container. To create these files, you need the following PEM-formatted files:

* Private key, typically a .pem or .key file
* Certificate, typically a .pem, .crt, .cer, or .cert file
* Certificate authority (CA) certificate, typically a .pem, .crt, .cer, or .cert file
* Certificate chain, which is a concatenated list of certificates, typically a .pem file

If the files provided by your certificate authority are not in PEM format, you can use a tool such as [OpenSSL](https://www.openssl.org/) to convert files to required PEM format. OpenSSL can also be used to generate PKCS #12 files from the listed certificates and private key.

### Adding trusted certificate authorities and self-signed certificates

For encrypted connections, you can define a set of trusted certificate authorities (CAs) and self-signed certificates, which are used to verify the identities of parties involved in the connection.

How you define these trusted certificates differs for each container: The SIP Orchestrator requires a PKCS #12 file, and the Media Relay can use any PEM-formatted file.

#### Adding trusted certificates for the SIP Orchestrator

Adding trusted certificates to the SIP Orchestrator secures connections to the Watson Conversation service. To define trusted certificates for the SIP Orchestrator, provide a PKCS #12 file with the truststore that contains the certificates to trust.

1. Generate a PKCS #12 file that contains the certificates from the CA to trust. The following example was generated by using the OpenSSL tool.
    ```text
    $ keytool -importcert \
        -file <certificate to trust> \
        -alias <alias for the certificate> \
        -keystore <name of the trustore> \
        -storepass <password for the truststore> \
        -storetype pkcs12
    ```

1. Mount the file on a Docker volume. For more information, see the [Docker documentation](https://docs.docker.com/compose/compose-file/#/volumes-volumedriver).

    ```yaml
    volumes:
      - $PWD:/sslConf/ # $PWD resolves to the working directory and mounts it to the /sslConf/ path on the container
    ```

1. In the SIP Orchestrator configuration, specify the file location and its corresponding passphrase on the `SSL_CLIENT_PKCS12_FILE` and `SSL_CLIENT_PASSPHRASE` environment variables.

    ```yaml
    environment:
      ...
      - SSL_CLIENT_PKCS12_FILE=/sslConf/myPKCS12File.p12
      - SSL_CLIENT_PASSPHRASE=myPassphrase
    ```

#### Adding trusted certificates for the Media Relay

Adding trusted certificates to the Media Relay secures connections to the Watson Speech To Text and Text to Speech services. To define trusted certificates for the Media Relay, provide a PEM-formatted file that contains all root certificate authorities to trust.

1. Create the file containing the certificates to trust in PEM format. This file usually has the following structure:

    ```text
    -----BEGIN CERTIFICATE-----
      ...
    -----END CERTIFICATE-----
    -----BEGIN CERTIFICATE-----
      ...
    -----END CERTIFICATE-----
    ```

    You can concatenate the certificates by using the `cat` command:

    ```
    $ cat cert1.pem cert2.pem ... > ca-bundle.pem
    ```

1. Mount the file on a Docker volume. For more information, see the [Docker documentation](https://docs.docker.com/compose/compose-file/#/volumes-volumedriver).

    ```yaml
    volumes:
      - $PWD:/sslConf/ # $PWD resolves to the working directory and mounts it to the /sslConf/ path on the container
    ```

1. In the Media Relay configuration, specify the PEM file location on the `SSL_CLIENT_CA_CERTIFICATE_FILE` environment variable.
    ```yaml
    environment:
      ...
      # Assume the file containing the certificates is called ca-bundle.pem
      - SSL_CLIENT_CA_CERTIFICATE_FILE=/sslConf/ca-bundle.pem
    ```

### Configuring mutual authentication

If you are connecting to the Watson services through a gateway server that requires mutual authentication, you'll have to configure mutual authentication in the voice gateway.

The simplest way to configure mutual authentication is by defining a single PKCS #12 file, which can be used for both the SIP Orchestrator and the Media Relay. The PKCS #12 file must contain the private key and its certificate as well as the certificate authorities to trust.

**Note:** This single PKCS #12 file can be used only if mutual authentication is configured. If you configure SSL or TLS without mutual authentication, you'll need separate files for the SIP Orchestrator and Media Relay as described in the [Configuring SSL/TLS encryption](#configuring-ssltls-encryption) section.

1. Generate the PKCS #12 file from the private key, its certificate, and the certificate chain. The following example was generated by using the OpenSSL tool.

    ```bash
$ openssl pkcs12 -export \
  -in <certificate file> \
  -inkey <private key file> \
  -CAfile <certificate chain> \
  -chain -out <filename>.p12
    ```  

1. Add the trusted certificates to the PKCS #12 file.

   ```text
$ keytool -importcert \
    -file <certificate to trust> \
    -alias <alias for the certificate> \
    -keystore <name of the trustore> \
    -storepass <password for the truststore> \
    -storetype pkcs12
    ```

1. Mount the file on a Docker volume. For more information, see the [Docker documentation](https://docs.docker.com/compose/compose-file/#/volumes-volumedriver).

    ```yaml
    volumes:
      - $PWD:/sslConf/ # $PWD will resolve to the working directory and will mount it to the /sslConf/ path on the container
    ```

1. In the configuration for each container, specify the file location and its corresponding passphrase on the `SSL_CLIENT_PKCS12_FILE` and `SSL_CLIENT_PASSPHRASE` environment variables.

   ```yaml
   environment:
     ...
     - SSL_CLIENT_PKCS12_FILE=/sslConf/myPKCS12File.p12
     - SSL_CLIENT_PASSPHRASE=myPassphrase
   ```

## Whitelisting callers and callees

You can _whitelist_ calls to or from certain SIP URIs, which means that only calls to or from the defined SIP URI are accepted by the voice gateway. When a caller attempts to reach the voice gateway, the caller's SIP URI is passed, which contains information such as the phone number and host in the following format:
```
sip:number_or_username@host_domain_or_IP[:port]

Example:
sip:12345678@myhost.com
```

For example, if you whitelist a certain host, only calls from that host can connect to the voice gateway. When whitelisting is configured, any SIP URI that is not explicitly allowed will not go through.

To configure whitelisting, define the following SIP Orchestrator environment variables.

| Environment variable | Default value | Description |
| -------------- | -------------------- | --------------------------------------------------------------- |
| WHITELIST_FROM_URI | none | The voice gateway will accept only calls that contain the specified string (such as a phone number) within the SIP from URI. |
| WHITELIST_TO_URI | none | The voice gateway will accept only calls that contain the specified string (such as a phone number) within the SIP to URI. |

For example, the following configuration allows only calls with `12345678` in the SIP from URI, such as `sip:12345678@myhost.com`.
```
WHITELIST_FROM_URI=12345678
```

For more information about configuration, see [Configuration environment variables for the voice gateway](config.md).
